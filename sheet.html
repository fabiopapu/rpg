
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scheda PG ‚Äì Fantasy Web</title>
  <!-- Favicon scudo azzurro -->
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="%237de3ff"/><stop offset="100%" stop-color="%2300a6cc"/></linearGradient></defs><path d="M32 4l22 8v16c0 14-11 24-22 28C21 52 10 42 10 28V12l22-8z" fill="url(%23g)" stroke="%23006680" stroke-width="2"/></svg>' />
  <style>
    :root{ --text:#f5e6c8; --ink:#2a1808; --gold:#b88a4a; --gold2:#e4b96c; --cyan:#7de3ff; --card:rgba(40,25,10,.86); --ring:0 0 0 .15rem rgba(125,227,255,.35); }
    *{box-sizing:border-box;transition:all .3s ease}
    html,body{height:100%}
    body{margin:0;font-family:"Cinzel", ui-serif, Georgia, serif; color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(60,45,25,.45), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(120,90,40,.35), transparent 70%),
        radial-gradient(1200px 900px at 50% 120%, rgba(40,20,5,.65), #0b0906 70%);
      background-attachment: fixed;}
    header{position:sticky;top:0;z-index:5;backdrop-filter: blur(6px);background:rgba(20,10,5,.65);border-bottom:2px solid var(--gold)}
    .wrap{max-width:1280px;margin:0 auto;padding:14px}
    h1{margin:0;font-size:22px;color:var(--cyan)} h3{margin:0 0 10px}
    main{padding:14px;animation:fadeIn 1s ease}
    .grid{display:grid;gap:14px}
    @media(min-width:1024px){ .grid.cols-2{grid-template-columns: 1.1fr 1.3fr} .bottom-grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:2px solid var(--gold);border-radius:18px;padding:14px;box-shadow:0 14px 30px rgba(0,0,0,.45);animation:fadeIn .6s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(0,0,0,.55)}
    .row{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center;margin:6px 0}
    label{color:#f0d9abcc;font-size:13px}
    input,select,textarea,button{font:inherit}
    input[type=text],input[type=number],select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #8f6b3e;background:#120a04;color:var(--text);outline:none}
    input:focus,select:focus,textarea:focus{box-shadow:var(--ring);border-color:#4a90e2}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .btn{cursor:pointer;border:none;border-radius:10px;padding:9px 12px;color:#140a05;font-weight:700;transition:transform .2s ease}
    .btn:hover{transform:scale(1.05)} .btn-acc{background:var(--gold2)} .btn-acc2{background:#ffd580} .btn-cyan{background:var(--cyan)} .btn-danger{background:#ff6b6b}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #8f6b3e;padding:8px;text-align:left;font-size:14px} th{background:rgba(60,30,10,.55);color:#ffe6b0}
    .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px} .kpi .chip{background:#0d0702;border:1px solid #8f6b3e;padding:6px 10px;border-radius:12px}
    .right{margin-left:auto} .footer-note{font-size:12px;color:#f3e2bf;opacity:.9}
    dialog{border:none;border-radius:16px;padding:0;max-width:720px;width:90%} dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal{background:#0f0b06;color:var(--text);border:2px solid var(--gold);border-radius:16px}
    .modal header{position:sticky;top:0;background:#1a120a;border-bottom:1px solid var(--gold);border-radius:16px 16px 0 0}
    .modal .content{padding:12px} code{white-space:pre-wrap;word-break:break-word}
    #background, #note{min-height:260px}
    .bottom-grid{display:grid;gap:14px;margin-top:20px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <h1>üõ°Ô∏è Scheda PG ‚Äì Fantasy Web</h1>
      <span style="display:flex;gap:8px;align-items:center;background:rgba(13,7,2,.6);border:1px solid #8f6b3e;padding:6px 10px;border-radius:999px">
        <span>Profilo</span>
        <input id="saveName" placeholder="nome_scheda" style="width:170px">
        <button class="btn btn-cyan" id="btnLoad">Carica</button>
        <button class="btn btn-acc" id="btnSave">Salva</button>
        <button class="btn btn-acc2" id="btnList">Elenco</button>
        <button class="btn" id="btnPreview">Mostra JSON</button>
        <button class="btn" id="btnExport">Esporta JSON</button>
        <label class="btn btn-acc2" for="fileImport" style="cursor:pointer">Carica JSON</label>

        <input id="fileImport" type="file" accept="application/json" style="display:none" />
      </span>
      <span class="right"></span>
    </div>
  </header>

  <main class="wrap">
    <div class="grid cols-2" style="margin-top:12px">
      <!-- Colonna sinistra -->
      <section class="card">
        <h3>üìá Info Personaggio</h3>
        <div id="info"></div>

        <h3 style="margin-top:10px">üí™ Caratteristiche</h3>
        <div id="caratt"></div>
        <div class="kpi" id="bonusKpi"></div>

        <h3 style="margin-top:10px">üéí Equipaggiamento</h3>
        <div class="toolbar">
          <button class="btn btn-acc2" id="addEq">Aggiungi Oggetto</button>
        </div>
        <table id="tabEq">
          <thead><tr><th style="width:50%">Oggetto</th><th>Peso</th><th>Ingombro</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="kpi" id="sumEq"></div>

        <h3 style="margin-top:10px">ü™ô Borsellino</h3>
        <div class="kpi" id="borsa"></div>

        <h3 style="margin-top:10px">‚öîÔ∏è Armi & Difesa</h3>
        <div id="armi"></div>
      </section>

      <!-- Colonna destra -->
      <section class="card">
        <h3>‚ù§Ô∏è Stato</h3>
        <div id="stati"></div>
        <div class="kpi" id="statiKpi"></div>

        <h3 style="margin-top:10px">üß† Abilit√†</h3>
        <div class="toolbar">
          <button class="btn btn-acc" id="addAb">Aggiungi Abilit√†</button>
        </div>
        <table id="tabAb">
          <thead><tr><th>Abilit√†</th><th>Livello</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    </div>

    <!-- Background e Note in fondo, due cornici affiancate -->
    <div class="bottom-grid">
      <section class="card">
        <h3>üìú Background</h3>
        <textarea id="background" placeholder="Storia del personaggio..."></textarea>
      </section>
      <section class="card">
        <h3>üóíÔ∏è Note</h3>
        <textarea id="note" placeholder="Appunti di gioco..."></textarea>
      </section>
    </div>
  </main>

  <dialog id="dlg" class="modal">
    <header class="wrap"><h3 style="margin:8px 0">Anteprima JSON</h3></header>
    <div class="content wrap"><code id="jsonOut"></code></div>
    <div class="wrap" style="display:flex;gap:8px;justify-content:flex-end;padding:12px"><button class="btn" onclick="dlg.close()">Chiudi</button></div>
  </dialog>

  <dialog id="listDlg" class="modal">
    <header class="wrap"><h3 style="margin:8px 0">Profili salvati nel browser</h3></header>
    <div class="content wrap" id="savedList"></div>
    <div class="wrap" style="display:flex;gap:8px;justify-content:flex-end;padding:12px"><button class="btn" onclick="listDlg.close()">Chiudi</button></div>
  </dialog>

<script>
// -------------------- MODEL --------------------
const caratteristiche = ['possenza','resistenza','atletica','manualita','percezione','sapienza','carisma'];
const livelli = ['Neofita','Pratico','Esperto','Veterano','Maestro'];
const armi = [
  '','Falcetto 2D10','Accetta 4D10','Pugnale 3D10','Sica 4D10','Daga 4D10','Spada Corta 6D10','Ascia 5D10',
  'Sciabola 5D10','Spada 5D10','Spadone 6D10','Falchion 5D10','Ascia Bipenne 6D10',
  'Randello 3D10','Mazza Chiodata 6D10','Mazzafrusto 5D10','Clava 4D10','Martello da Guerra 6D10',
  'Lancia 5D10','Alabarda 6D10','Bardica 6D10',
  'Balestra piccola a 1 mano 4D10','Balestra Grande 5D10','Arco piccolo 4D10','Arco Lungo Composito 5D10',
  'Balestra multidardo a 2 mani 4D10','Frusta 4D10'
];
const difese = ['0','+1','+2','+3'];

const state = {
  info: {nome:'', livello:'', pe:'', razza:'', classe:'', eta:'', fortuna:''},
  car: Object.fromEntries(caratteristiche.map(k=>[k,''])),
  stato: { indice_ferite: 1, danni_ferite: 0, indice_stanchezza: 1, danni_stanchezza: 0, indice_paura: 1, danni_paura: 0 },
  abilita: [], // [{nome, livello}]
  equip: [],   // [{oggetto, peso, ingombro}]
  borsa: {MO:0, MA:0, MR:0},
  armi: {arma1:'', arma2:''},
  difesa: {armatura:'0', scudo:'0'},
  background: '',
  note: ''
};

// -------------------- STORAGE (LocalStorage) --------------------
const LS_PREFIX = 'gdr_pg_';
const LS_INDEX  = 'gdr_pg_index';
const getIndex = () => JSON.parse(localStorage.getItem(LS_INDEX)||'[]');
const setIndex = (arr) => localStorage.setItem(LS_INDEX, JSON.stringify([...new Set(arr)]));
const keyFor = (name) => LS_PREFIX + name;
function saveLocal(name, data){ if(!name) throw new Error('Nome profilo mancante'); localStorage.setItem(keyFor(name), JSON.stringify(data)); const idx = getIndex(); if(!idx.includes(name)){ idx.push(name); setIndex(idx); } }
function loadLocal(name){ const raw = localStorage.getItem(keyFor(name)); if(!raw) return null; try{ return JSON.parse(raw); }catch{ return null; } }
function listNames(){ return getIndex().sort((a,b)=> a.localeCompare(b)); }

// -------------------- UI BUILD --------------------
function el(tag, attrs={}, children=[]) { const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==='class') e.className=v; else if(k==='html') e.innerHTML=v; else if(k.startsWith('on')) e.addEventListener(k.slice(2),v); else e.setAttribute(k,v); }); children.forEach(c=> e.appendChild(typeof c==='string'?document.createTextNode(c):c)); return e; }

function buildInfo(){ const container=document.getElementById('info'); container.innerHTML=''; const fields=[["Nome","nome"],["Livello","livello"],["PE","pe"],["Razza","razza"],["Classe","classe"],["Et√†","eta"],["Fortuna","fortuna"]]; fields.forEach(([label,key])=>{ const row=el('div',{class:'row'},[el('label',{for:key},[label]), el('input',{id:key, value:state.info[key]||'', oninput:e=>{state.info[key]=e.target.value}})]); container.appendChild(row); }); }

function buildCaratt(){ const container=document.getElementById('caratt'); container.innerHTML=''; caratteristiche.forEach(k=>{ const row=el('div',{class:'row'},[ el('label',{for:k},[k.charAt(0).toUpperCase()+k.slice(1)]), el('input',{id:k, type:'number', value:state.car[k], oninput:e=>{state.car[k]=e.target.value; renderBonus();}}) ]); container.appendChild(row); }) }

function calcolaBonus(val){ let v=parseInt(val); if(isNaN(v)) return 0; if(v<5) v=5; if(v>15) v=15; const map={5:0,6:-1,7:-1,8:-2,9:-2,10:-3,11:-4,12:-5,13:-6,14:-7,15:-8}; return map[v]??0; }
function renderBonus(){ const box=document.getElementById('bonusKpi'); box.innerHTML=''; caratteristiche.forEach(k=>{ const b=calcolaBonus(state.car[k]); box.appendChild(el('div',{class:'chip'},[`${k}: Bonus ${b}`])); }); }

function calcolaStato(indice,danni,tipi){ const maxs=[...Array(tipi.length-1).keys()].map(i=> indice*(i+1)); for(let i=0;i<maxs.length;i++){ if(danni<=maxs[i]) return tipi[i]; } return tipi[tipi.length-1]; }
function buildStati(){ const wrap=document.getElementById('stati'); wrap.innerHTML=''; const cfg=[ {label:'Ferite', v1:'indice_ferite', v2:'danni_ferite', tipi:['Lieve','Media','Lacerante','Profonda','Critica','Grave']}, {label:'Affaticamento', v1:'indice_stanchezza', v2:'danni_stanchezza', tipi:['Riposato','Fresco','Affaticato','Stanco','Stremato']}, {label:'Paura', v1:'indice_paura', v2:'danni_paura', tipi:['Quieto','Teso','Intimorito','Spaventato','Panico']}, ]; cfg.forEach(c=>{ const row=el('div',{class:'row'},[ el('label',{},[c.label+ ' indice']), el('input',{type:'number', value:state.stato[c.v1], oninput:e=>{state.stato[c.v1]=toInt(e.target.value,1); renderStatiKpi();}}), ]); const row2=el('div',{class:'row'},[ el('label',{},[c.label+' danni']), el('input',{type:'number', value:state.stato[c.v2], oninput:e=>{state.stato[c.v2]=toInt(e.target.value,0); renderStatiKpi();}}) ]); wrap.appendChild(row); wrap.appendChild(row2); }); }
function renderStatiKpi(){ const box=document.getElementById('statiKpi'); box.innerHTML=''; const cfg=[ {key:['indice_ferite','danni_ferite'], tipi:['Lieve','Media','Lacerante','Profonda','Critica','Grave'], label:'Ferite'}, {key:['indice_stanchezza','danni_stanchezza'], tipi:['Riposato','Fresco','Affaticato','Stanco','Stremato'], label:'Affaticamento'}, {key:['indice_paura','danni_paura'], tipi:['Quieto','Teso','Intimorito','Spaventato','Panico'], label:'Paura'}, ]; cfg.forEach(c=>{ const st = calcolaStato(toInt(state.stato[c.key[0]],1), toInt(state.stato[c.key[1]],0), c.tipi); box.appendChild(el('div',{class:'chip'},[`${c.label}: ${st}`])); }) }

function buildAbilita(){ const tbody=document.querySelector('#tabAb tbody'); tbody.innerHTML=''; state.abilita.forEach((a,idx)=> tbody.appendChild(renderAbRow(a,idx)) ); }
function renderAbRow(a,idx){ const tr=el('tr'); const td1=el('td',{},[el('input',{value:a.nome||'', oninput:e=>{a.nome=e.target.value;}})]); const sel=el('select',{}, livelli.map(l=>el('option',{value:l,selected:l===a.livello},[l]))); sel.addEventListener('change', e=> a.livello=e.target.value); const td2=el('td',{},[sel]); const td3=el('td',{},[el('button',{class:'btn btn-danger', onclick:()=>{state.abilita.splice(idx,1); buildAbilita();}},['Rimuovi'])]); tr.append(td1,td2,td3); return tr; }

function buildEquip(){ const tbody=document.querySelector('#tabEq tbody'); tbody.innerHTML=''; state.equip.forEach((e,idx)=> tbody.appendChild(renderEqRow(e,idx)) ); renderSommaEq(); }
function renderEqRow(obj,idx){ const tr=el('tr'); const td1=el('td',{},[el('input',{value:obj.oggetto||'', oninput:e=>{obj.oggetto=e.target.value;}})]); const td2=el('td',{},[el('input',{type:'number', step:'0.01', value:obj.peso??'', oninput:e=>{obj.peso=e.target.value; renderSommaEq();}})]); const td3=el('td',{},[el('input',{type:'number', step:'0.01', value:obj.ingombro??'', oninput:e=>{obj.ingombro=e.target.value; renderSommaEq();}})]); const td4=el('td',{},[el('button',{class:'btn btn-danger', onclick:()=>{state.equip.splice(idx,1); buildEquip();}},['Rimuovi'])]); tr.append(td1,td2,td3,td4); return tr; }
function renderSommaEq(){ const peso = state.equip.reduce((s,e)=> s + (parseFloat(e.peso)||0), 0); const ing  = state.equip.reduce((s,e)=> s + (parseFloat(e.ingombro)||0), 0); const box=document.getElementById('sumEq'); box.innerHTML=''; box.appendChild(el('div',{class:'chip'},[`Somma Peso: ${peso}`])); box.appendChild(el('div',{class:'chip'},[`Somma Ingombro: ${ing}`])); }

function buildBorsa(){ const box=document.getElementById('borsa'); box.innerHTML=''; ['MO','MA','MR'].forEach(k=>{ const spin=el('input',{type:'number', min:'0', value: state.borsa[k]||0, oninput:e=> state.borsa[k]=toInt(e.target.value,0)}); box.appendChild(el('div',{class:'chip'},[k+': ', spin])); }) }
function buildArmi(){ const box=document.getElementById('armi'); box.innerHTML=''; const rows=[['Arma 1','arma1',armi],['Arma 2','arma2',armi],['Armatura','armatura',difese],['Scudo','scudo',difese]]; rows.forEach(([label,key,opts])=>{ const current = (key==='armatura'||key==='scudo') ? state.difesa[key] : state.armi[key]; const sel=el('select',{}, opts.map(o=> el('option',{value:o,selected:o===current},[o]) )); sel.addEventListener('change', e=>{ if(key==='armatura'|| key==='scudo') state.difesa[key]=e.target.value; else state.armi[key]=e.target.value; }); const row=el('div',{class:'row'},[el('label',{},[label]),sel]); box.appendChild(row); }) }

function toInt(v,def){ const n=parseInt(v); return Number.isFinite(n)?n:def; }

// -------------------- SAVE/LOAD (LocalStorage + Import/Export) --------------------
function collect(){ return { info: structuredClone(state.info), car: structuredClone(state.car), stato: structuredClone(state.stato), abilita: state.abilita.map(a=>({nome:a.nome||'', livello:a.livello||'Neofita'})), equip: state.equip.map(e=>({oggetto:e.oggetto||'', peso: numOrNull(e.peso), ingombro: numOrNull(e.ingombro)})), borsa: structuredClone(state.borsa), armi: structuredClone(state.armi), difesa: structuredClone(state.difesa), background: document.querySelector('#background').value, note: document.querySelector('#note').value }; }
function numOrNull(v){ const n=parseFloat(v); return Number.isFinite(n)?n:null; }
function applyData(d){ Object.assign(state.info, d.info||{}); Object.assign(state.car, d.car||{}); Object.assign(state.stato, d.stato||{}); state.abilita = (d.abilita||[]).map(a=>({nome:a.nome, livello:a.livello})); state.equip = (d.equip||[]).map(e=>({oggetto:e.oggetto, peso:e.peso, ingombro:e.ingombro})); Object.assign(state.borsa, d.borsa||{}); Object.assign(state.armi, d.armi||{}); Object.assign(state.difesa, d.difesa||{}); document.querySelector('#background').value = d.background||''; document.querySelector('#note').value = d.note||''; buildInfo(); buildCaratt(); renderBonus(); buildStati(); renderStatiKpi(); buildAbilita(); buildEquip(); buildBorsa(); buildArmi(); }

function doSave(){ const name=document.querySelector('#saveName').value.trim(); if(!name){ alert('Inserisci un nome profilo (solo lettere/numeri/_-)'); return; } saveLocal(name, collect()); alert('Salvato nel browser: '+name); }
function doLoad(){ const name=document.querySelector('#saveName').value.trim(); if(!name){ alert('Inserisci un nome profilo da caricare'); return; } const data = loadLocal(name); if(!data){ alert('Profilo non trovato'); return; } applyData(data); alert('Caricato: '+name); }
function showList(){ const arr = listNames(); const box=document.getElementById('savedList'); box.innerHTML=''; if(!arr.length){ box.textContent='Nessun profilo salvato nel browser.'; listDlg.showModal(); return; } const ul=el('ul'); arr.forEach(n=>{ const li=el('li',{},[ n,' ', el('button',{class:'btn btn-cyan', onclick:()=>{document.querySelector('#saveName').value=n; doLoad(); listDlg.close();}},['Carica']), ' ', el('button',{class:'btn btn-danger', onclick:()=>{ if(confirm('Eliminare "'+n+'"?')){ localStorage.removeItem(keyFor(n)); const idx=getIndex().filter(x=>x!==n); setIndex(idx); showList(); } }},['Elimina']) ]); ul.appendChild(li); }); box.appendChild(ul); listDlg.showModal(); }
function exportJSON(){ const data = collect(); const name = (document.querySelector('#saveName').value.trim()||'scheda') + '.json'; const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url); }
function importJSON(file){ const reader = new FileReader(); reader.onload = e => { try{ const obj = JSON.parse(e.target.result); applyData(obj); alert('Import riuscito. Ricorda di SALVARE nel browser se vuoi tenerlo.'); }catch(err){ alert('JSON non valido.'); } }; reader.readAsText(file); }

// -------------------- INIT --------------------
function mount(){ buildInfo(); buildCaratt(); renderBonus(); buildStati(); renderStatiKpi(); buildAbilita(); buildEquip(); buildBorsa(); buildArmi(); document.getElementById('addAb').onclick=()=>{ state.abilita.push({nome:'', livello:'Neofita'}); buildAbilita(); }; document.getElementById('addEq').onclick=()=>{ state.equip.push({oggetto:'', peso:'', ingombro:''}); buildEquip(); }; document.getElementById('btnSave').onclick=doSave; document.getElementById('btnLoad').onclick=doLoad; document.getElementById('btnList').onclick=showList; document.getElementById('btnPreview').onclick=()=>{ const j=JSON.stringify(collect(), null, 2); document.getElementById('jsonOut').textContent=j; document.getElementById('dlg').showModal(); }; document.getElementById('btnExport').onclick=exportJSON; document.getElementById('fileImport').addEventListener('change', (e)=>{ if(e.target.files?.[0]) importJSON(e.target.files[0]); e.target.value=''; }); }
window.addEventListener('DOMContentLoaded', mount);
</script>
</body>
</html>
